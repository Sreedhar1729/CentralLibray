sap.ui.define(["./BaseController","sap/ui/core/mvc/Controller","sap/ui/model/odata/v2/ODataModel","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,o,t,s){"use strict";return e.extend("com.app.centrallibrary.controller.Details",{onInit:function(){const e=this.getOwnerComponent().getRouter();e.attachRoutePatternMatched(this.onUserDetailsLoad,this)},onUserDetailsLoad:function(e){const{ID:o}=e.getParameter("arguments");this.id=o;const t=e.getParameter("name");const s=this.getView().byId("ObjectPageLayout");s.bindElement(`/Users(${o})`)},onBorrowNewBookPress:async function(e){var o=e.getSource().getParent();console.log(o);var t=o.getBindingContext().getObject();if(this.byId("idBooksTable").getSelectedItems().length==0){sap.m.MessageBox.error("Please select at least one book for Reservation");return}if(this.byId("idBooksTable").getSelectedItems().length>1){sap.m.MessageBox.error("Please select only one book for Reservation");return}var s=this.byId("idBooksTable").getSelectedItem().getBindingContext().getObject();if(s.avl_stock==0){sap.m.MessageBox.error("AVL quantity is ZERO!!!")}else{debugger;const e=await this.checkIfBookIsReservedByUser(s.ID,t.ID);if(e){sap.m.MessageBox.error("This Book is already Reserved by YOU!!!");return}const o=await this.checkIfBookIsBorrowedByUser(s.ID,t.ID);if(o){sap.m.MessageBox.error("Book is  already borrowed by YOU!!!!.");return}const r=new sap.ui.model.json.JSONModel({users_ID:t.ID,books_ID:s.ID,reservedate:new Date});this.getView().setModel(r,"userModel");const i=this.getView().getModel("userModel").getProperty("/"),n=this.getView().getModel("ModelV2");try{await this.createData(n,i,"/ReservedBooks");sap.m.MessageBox.success(`Book ID: ${i.books_ID} is  reserved Successfully!!`)}catch(e){sap.m.MessageBox.error("Some technical issue occurred")}}},createData:function(e,o,t){return new Promise((s,r)=>{e.create(t,o,{refreshAfterChange:true,success:function(e){s(e)},error:function(e){r(e)}})})},onNotificationPress:async function(){if(!this.oNotificationDialog){this.oNotificationDialog=await this.loadFragment("Notification")}this.oNotificationDialog.open();const e=this.getView().byId("idDialogNotify");e.bindElement(`/Users(${this.id})`)},onCloseNotification:function(){if(this.oNotificationDialog.isOpen()){this.oNotificationDialog.close()}},onHome:async function(){const e=this.getOwnerComponent().getRouter();e.navTo("RouteView1",{},true)},checkIfBookIsReservedByUser:function(e,o){return new Promise((t,s)=>{const r=this.getView().getModel("ModelV2");const i=[new sap.ui.model.Filter("books_ID",sap.ui.model.FilterOperator.EQ,e),new sap.ui.model.Filter("users_ID",sap.ui.model.FilterOperator.EQ,o)];r.read("/ReservedBooks",{filters:i,success:function(e){console.log("Data received:",e);if(e&&e.results){const o=e.results.length>0;console.log("Is reserved:",o);t(o)}else{s("No data received from service")}},error:function(e){console.error("Error:",e);s(e)}})})},checkIfBookIsBorrowedByUser:function(e,o){debugger;return new Promise((t,s)=>{const r=this.getView().getModel("ModelV2");const i=[new sap.ui.model.Filter("books_ID",sap.ui.model.FilterOperator.EQ,e),new sap.ui.model.Filter("users_ID",sap.ui.model.FilterOperator.EQ,o)];r.read("/BooksLoan",{filters:i,success:function(e){console.log("Bookloans data:",e);const o=e.results.some(e=>e.Active===true);console.log("Active loans found:",o);t(o)},error:function(e){console.error("Error reading Bookloans:",e);s(e)}})})}})});